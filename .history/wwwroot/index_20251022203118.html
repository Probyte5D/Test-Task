async function loadTests() {
    const res = await fetch('http://localhost:5155/api/Test');
    tests = await res.json();
    const select = document.getElementById('testSelect');

    tests.forEach(t => {
        const opt = document.createElement('option');
        // usa id coerente (_id oppure id)
        opt.value = t._id || t.id;
        // usa titolo coerente (Title oppure title)
        opt.textContent = t.Title || t.title;
        select.appendChild(opt);
    });
}

function startTest() {
    const name = document.getElementById('userName').value.trim();
    const testId = document.getElementById('testSelect').value;

    if (!name || !testId) {
        document.getElementById('homeError').textContent = "Inserisci il nome e scegli un test!";
        return;
    }

    document.getElementById('home').classList.add('hidden');
    // trova il test usando _id o id
    currentTest = tests.find(t => (t._id || t.id) === testId);
    currentQuestionIndex = 0;
    correctAnswers = 0;
    showQuestion();
    document.getElementById('testView').classList.remove('hidden');
}

function showQuestion() {
    // compatibilità: Questions o questions
    const questions = currentTest.Questions || currentTest.questions;
    const question = questions[currentQuestionIndex];
    const container = document.getElementById('questionContainer');
    container.innerHTML = `<div class="question-card">
        <p><strong>Domanda ${currentQuestionIndex + 1} di ${questions.length}:</strong> ${question.Text || question.text}</p>
    </div>`;

    // compatibilità: Options o options
    const options = question.Options || question.options;
    options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = opt.Text || opt.text;
        btn.onclick = () => selectAnswer(i);
        container.appendChild(btn);
    });

    updateProgress(questions.length);
}

function updateProgress(totalQuestions) {
    const percent = ((currentQuestionIndex) / totalQuestions) * 100;
    document.getElementById('progressBar').style.width = percent + "%";
}

function selectAnswer(index) {
    const questions = currentTest.Questions || currentTest.questions;
    const question = questions[currentQuestionIndex];
    const options = question.Options || question.options;
    const buttons = document.querySelectorAll('.answer-btn');

    buttons.forEach((btn, i) => {
        if (i === index) {
            btn.classList.add(options[i].IsCorrect || options[i].isCorrect ? 'correct' : 'wrong');
        }
        btn.disabled = true;
    });

    if (options[index].IsCorrect || options[index].isCorrect) correctAnswers++;

    setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex >= questions.length) {
            finishTest();
        } else {
            showQuestion();
        }
    }, 500);
}
