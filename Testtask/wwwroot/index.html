<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Test System</title>
<style>
    body { font-family: Arial; margin: 20px; text-align: center; background: #f9f9f9; }
    .hidden { display: none; }
    .question-card { margin-bottom: 20px; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: inline-block; text-align: left; background: #fff; }
    .progress { width: 100%; background: #eee; height: 20px; margin-bottom: 20px; border-radius: 10px; }
    .progress-bar { width: 0; height: 100%; background: #4caf50; border-radius: 10px; transition: width 0.3s; }
    .answer-btn { display: block; width: 300px; margin: 10px auto; padding: 15px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
    .answer-btn:hover { transform: scale(1.05); }
    .answer-btn.correct { background-color: #4caf50; color: white; }
    .answer-btn.wrong { background-color: #f44336; color: white; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 8px; }
    .result-answer { text-align: left; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #ccc; }
</style>
</head>
<body>

<h1>Task Test</h1>

<div id="home">
    <label>Nome: <input type="text" id="userName" placeholder="Es. Mario Rossi"></label><br><br>
    <label>Scegli un test:
        <select id="testSelect">
            <option value="">-- Seleziona un test --</option>
        </select>
    </label><br><br>
    <button onclick="startTest()">Inizia Test</button>
    <p id="homeError" style="color:red;"></p>
</div>

<div id="testView" class="hidden">
    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <div id="questionContainer"></div>
    <p id="testError" style="color:red;"></p>
</div>

<div id="resultView" class="hidden">
    <h2>Risultato finale</h2>
    <p id="resultText"></p>
    <div id="detailedAnswers"></div>
    <button onclick="restartTest()">Ricomincia</button>
</div>

<script>
let tests = [];
let currentTest = null;
let currentQuestionIndex = 0;
let correctAnswers = 0;
let userResultId = null;

// Carica i test all’avvio
async function loadTests() {
    const res = await fetch('http://localhost:5155/api/Test');
    tests = await res.json();
    const select = document.getElementById('testSelect');
    tests.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.title;
        select.appendChild(opt);
    });
}

async function startTest() {
    const name = document.getElementById('userName').value.trim();
    const testId = document.getElementById('testSelect').value;

    if (!name || !testId) {
        document.getElementById('homeError').textContent = "Inserisci il nome e scegli un test!";
        return;
    }

    // Creo UserResult iniziale
    const res = await fetch('http://localhost:5155/api/UserResult', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            userName: name,
            testId: testId,
            correctAnswers: 0,
            totalQuestions: tests.find(t => t.id === testId).questions.length,
            answers: []
        })
    });
    const userResult = await res.json();
    userResultId = userResult.id;

    document.getElementById('home').classList.add('hidden');
    currentTest = tests.find(t => t.id === testId);
    currentQuestionIndex = 0;
    correctAnswers = 0;
    showQuestion();
    document.getElementById('testView').classList.remove('hidden');
}

function showQuestion() {
    const q = currentTest.questions[currentQuestionIndex];
    const container = document.getElementById('questionContainer');
    container.innerHTML = `<div class="question-card"><p><strong>Domanda ${currentQuestionIndex + 1} di ${currentTest.questions.length}:</strong> ${q.text}</p></div>`;

    q.options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = opt.text;
        btn.onclick = () => selectAnswer(i);
        container.appendChild(btn);
    });

    updateProgress();
}

function updateProgress() {
    const percent = ((currentQuestionIndex) / currentTest.questions.length) * 100;
    document.getElementById('progressBar').style.width = percent + "%";
}

async function selectAnswer(index) {
    const q = currentTest.questions[currentQuestionIndex];
    const selectedOption = q.options[index];
    const buttons = document.querySelectorAll('.answer-btn');

    buttons.forEach((btn, i) => {
        if (i === index) btn.classList.add(selectedOption.isCorrect ? 'correct' : 'wrong');
        btn.disabled = true;
    });

    if (selectedOption.isCorrect) correctAnswers++;

    // Salvo la risposta singola
    await fetch(`http://localhost:5155/api/UserResult/Answer?userResultId=${userResultId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            questionId: q.id,
            selectedOptionId: selectedOption.id,
            isCorrect: selectedOption.isCorrect
        })
    });

    setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex >= currentTest.questions.length) finishTest();
        else showQuestion();
    }, 500);
}

async function finishTest() {
    document.getElementById('testView').classList.add('hidden');
    document.getElementById('resultView').classList.remove('hidden');

    // Mostra risultato base
    document.getElementById('resultText').textContent =
        `Ciao ${document.getElementById('userName').value}, hai risposto correttamente a ${correctAnswers} su ${currentTest.questions.length} domande.`;

    // Aggiorna punteggio finale
    await fetch(`http://localhost:5155/api/UserResult/${userResultId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            correctAnswers: correctAnswers,
            totalQuestions: currentTest.questions.length
        })
    });

    // Carica dettagli con testi delle domande e risposte selezionate
    const detailsRes = await fetch(`http://localhost:5155/api/UserResult/${userResultId}/Details`);
    const details = await detailsRes.json();

    const container = document.getElementById('detailedAnswers');
    container.innerHTML = '';
    details.Answers.forEach((a, i) => {
        const div = document.createElement('div');
        div.className = 'result-answer';
        div.innerHTML = `<strong>Domanda ${i + 1}:</strong> ${a.QuestionText} <br>
                         <strong>Risposta scelta:</strong> ${a.SelectedOptionText} <br>
                         <strong>Corretta:</strong> ${a.IsCorrect ? 'Sì' : 'No'}`;
        container.appendChild(div);
    });
}

function restartTest() {
    document.getElementById('resultView').classList.add('hidden');
    document.getElementById('home').classList.remove('hidden');
    document.getElementById('userName').value = '';
    document.getElementById('testSelect').value = '';
    userResultId = null;
}

// Avvio
loadTests();
</script>

</body>
</html>
